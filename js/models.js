
// create a chip type class to represent a particular type / geometry / AR coating
// a chip type needs to have a QE profile, and maybe some other stuff later
function chip(paramObj){

    var self = this;

    if (!paramObj){
        //QE curve, in the form of a JSON with wavelength (nm) : QE (fraction range [0,1]) pairs
        paramObj = { 'QE' : {   300 : 0,
                                400 : 0.75,
                                500 : 1,
                                600 : 0
                            }};
    }

   // copy values from parameter object to self
   Object.keys(paramObj).forEach(function(k){self[k]=paramObj[k]})

    // function getQE() to return an interpolated QE based on known points
   this.getQE = function(lambda){
        // put your goggles on this is about to get GROSS
        var wavelengths = Object.keys(self.QE).map(parseFloat)
        wavelengths.sort(function(a,b){return a-b})  // sort the wavelength keys in case they're out of order
        var indexAbove = wavelengths.findIndex( function(x){return x>lambda});
        var wavelengthBounds = [wavelengths[indexAbove-1], wavelengths[indexAbove]];
        var QEBounds = [self.QE[wavelengthBounds[0]], self.QE[wavelengthBounds[1]]];
        
        // calculate the slope for linear interpolation
        var M = (QEBounds[1]-QEBounds[0])/(wavelengthBounds[1]-wavelengthBounds[0])

        // return a linearly interpolated value for the QE at a specific wavelength lambda
        return M*(lambda - wavelengthBounds[1]) + QEBounds[1]
   }

}


var models = { 'BR_DD' : new chip( { "QE" : {"200":0.070875498,"210":0.1208272127,"220":0.2463092853,"230":0.1785595121,"240":0.1115360705,"250":0.0815455007,"260":0.0715375786,"270":0.0732122654,"280":0.1109278917,"290":0.1794655393,"300":0.2268876939,"310":0.2805222207,"320":0.3170561991,"330":0.3385383236,"340":0.3516222113,"350":0.3547632671,"360":0.3459345709,"370":0.340067632,"380":0.368982831,"390":0.393602426,"400":0.4265481361,"410":0.4583744874,"420":0.4703249319,"430":0.4877361965,"440":0.5046388779,"450":0.5213234463,"460":0.5395678034,"470":0.5604921419,"480":0.5836394551,"490":0.6071770281,"500":0.6268088531,"510":0.6421525645,"520":0.6609046087,"530":0.6749493142,"540":0.695961574,"550":0.7093338424,"560":0.7268132817,"570":0.7404289731,"580":0.7578845351,"590":0.7718302347,"600":0.7887762813,"610":0.8022009463,"620":0.8178526907,"630":0.8321145802,"640":0.8455289539,"650":0.8572035688,"660":0.8692599957,"670":0.8798657912,"680":0.8903010583,"690":0.9004594721,"700":0.9095085845,"710":0.917842158,"720":0.9250046931,"730":0.9318204774,"740":0.9382583905,"750":0.9434495485,"760":0.9477248594,"770":0.9506269888,"780":0.9529137561,"790":0.9544693414,"800":0.9543090612,"810":0.952657616,"820":0.9489005949,"830":0.9436462119,"840":0.9366061229,"850":0.9266236963,"860":0.9137771617,"870":0.89730598,"880":0.8776709932,"890":0.8545197818,"900":0.8268084823,"910":0.7947524876,"920":0.7579481014,"930":0.7171678045,"940":0.6725912773,"950":0.6239953354,"960":0.5722604098,"970":0.5178676891,"980":0.4621454959,"990":0.4059527412,"1000":0.3499007002,"1010":0.2952178623,"1020":0.2429086387,"1030":0.1939237071,"1040":0.1491929616,"1050":0.1093093728,"1060":0.0749714753,"1070":0.0468482377,"1080":0.0251255173,"1090":0.0100071068,"1100":0.0017177833} } ) ,
                'BV' : new chip( { "QE" : {"200":0.0630221074,"210":0.080852218,"220":0.1289141683,"230":0.200487031,"240":0.2171079141,"250":0.1739112966,"260":0.1216812913,"270":0.083148068,"280":0.0799688743,"290":0.092160563,"300":0.0976404206,"310":0.1184681581,"320":0.1411809119,"330":0.1635292125,"340":0.1871006332,"350":0.2082929008,"360":0.2491247044,"370":0.3145234844,"380":0.4153228953,"390":0.508886073,"400":0.5811913214,"410":0.6400115057,"420":0.6784632477,"430":0.7198110746,"440":0.756165133,"450":0.7957083685,"460":0.8294099499,"470":0.8615328609,"480":0.8922787257,"490":0.9209263175,"500":0.9486406435,"510":0.9540523332,"520":0.9605476843,"530":0.9647550892,"540":0.9688513335,"550":0.9694024118,"560":0.9713997418,"570":0.9709470667,"580":0.9701015239,"590":0.9680484969,"600":0.9638228998,"610":0.962532041,"620":0.9592344689,"630":0.9552586311,"640":0.9507058913,"650":0.9424505474,"660":0.9398923112,"670":0.9336842372,"680":0.9269395848,"690":0.9195372113,"700":0.9085678624,"710":0.9024920835,"720":0.8926309118,"730":0.8817728235,"740":0.8697687315,"750":0.8538552402,"760":0.8418404686,"770":0.8256533795,"780":0.8079099114,"790":0.7884914026,"800":0.7650929462,"810":0.7445827824,"820":0.719861774,"830":0.6934155855,"840":0.6652406487,"850":0.6334622298,"860":0.6041760393,"870":0.5716019688,"880":0.5378620742,"890":0.5032028435,"900":0.4664254696,"910":0.4321320869,"920":0.3962351437,"930":0.360488497,"940":0.3251857525,"950":0.2897037733,"960":0.2570296426,"970":0.2247435444,"980":0.1940164346,"990":0.1650612492,"1000":0.1376596576,"1010":0.1132899825,"1020":0.0902533805,"1030":0.0703098043,"1040":0.0528429659,"1050":0.0378986759} } ),
                'FI' : new chip( { "QE" : {"400":0.007,"440":0.064,"490":0.21,"520":0.29,"550":0.34,"600":0.47,"640":0.48,"680":0.45,"700":0.49,"720":0.5,"750":0.48,"780":0.46,"810":0.41,"850":0.33,"880":0.27,"900":0.24,"930":0.18,"950":0.14,"1060":0.01} } ),
                'Ideal' : new chip({'QE':{"0":1,"1000":1}})
            }

var ching = 'chang'